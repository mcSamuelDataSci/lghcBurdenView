---
output:
  word_document:
    reference_docx: cntyReport_styles.docx
always_allow_html: yes
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r process, echo=FALSE, warning = FALSE, message=TRUE }
require(shiny)
require(rgdal)
require(sp)
require(maptools)
require(Rcpp)
require(ggplot2)
require(Hmisc)
require(dplyr)
require(zoo)
require(cowplot)
require(scales)
require(RColorBrewer)
require(knitr)
require(rmarkdown)
require(mapproj)
require(Cairo)

#Data for overdose plots
h.c <- subset(mm_ca,
               mm_ca$type == 'total' &
               mm_ca$demo == '0',
               c("year", "qtr", 'anyopioid', 'anyopioid_cr','rxopioid_incl_T404_cr', 
                  'heroin_cr', 'opioid_404_cr','edopioid_cr')
               )
h.c$yearqtr <- paste(h.c$year,h.c$qtr,sep="-Q")

#Alternative 12-month Rates
h.m <- as.data.frame(lapply(h.c[ ,c(3,4,5,6,7,8)],mav))
h.m[,1] <- h.m[,1]*4
names(h.m)[c(2:6)] <- c(paste0('anyopioid_cr',"_ann"),paste0('rxopioid_incl_T404_cr',"_ann"),paste0('heroin_cr',"_ann"),paste0('opioid_404_cr',"_ann"),paste0('edopioid_cr',"_ann"))
h.m <- cbind(h.c[,c(1:2,9)],h.m)
h.m <- as.data.frame(lapply(h.m, tail, 12))

h.s <- aggregate(h.c[c('anyopioid')], by=h.c["year"],  FUN=sum, na.rm=TRUE )
h.s <- as.data.frame(lapply(h.s, tail, 4)) #h.s <- as.data.frame(lapply(h.s, tail, 3)) Previous version changed 09/25/18
h.c <- as.data.frame(lapply(h.c, tail, 12)) # was 5

#maxyr <- max(h.s[,1])
maxyr <- 2017         ####change year to most up-to-date full year of data####
minyr <- min(h.s[,1])

#Pull Ethnic Data
e.c <- subset(mm_ca,
               mm_ca$type == 'ethnic' &
               mm_ca$year == maxyr,
               c('demo', 'anyopioid_aa')
)
e.m <- aggregate(e.c[c('anyopioid_aa')], by=e.c["demo"], FUN=mean, na.rm=TRUE )
e.m[[1]] <- lapply(e.m[[1]], function(x) demoDecode("ethnic",x))
e.m$demo <- unlist(e.m$demo)
e.m$demo <- as.factor(e.m$demo)

#Data for Map
mdf <- subset(mm_cnty,
              mm_cnty$type == 'total' &
              mm_cnty$demo == '0' &
              mm_cnty$year == maxyr,
              c("county", "anyopioid_aa"))
mdf <- aggregate(mdf[c("anyopioid_aa")], by=mdf["county"],  FUN=mean, na.rm=TRUE )
cm <- fortify(cnty.map, region = "NAME")

# merge the "fortified" data with the data from our spatial object
cm <- merge(cm, mdf, by.x = "id", by.y = "county")
cm <- cm[order(cm$order), ]

p1 <- ggplot(h.m, aes(x=yearqtr, y=rxopioid_incl_T404_cr_ann, group = 1)) +
    geom_line(color="blue",size=0.75)+
    geom_point(color="blue") +
    labs(title="Prescription OD 12-Month Death Rates", x=NULL, y = NULL) +
    theme_classic() +
    theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8)) 

p2 <- ggplot(h.c, aes(x=yearqtr, y=heroin_cr, group = 1)) +
  geom_line(color="steelblue",size=0.75)+
  geom_point(color="steelblue") +
  labs(title="Heroin OD Qtrly Death Rates",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))

p3 <- ggplot(h.c, aes(x=yearqtr, y=opioid_404_cr, group = 1)) +
  geom_line(color="royalblue",size=0.75)+
  geom_point(color="royalblue") +
  labs(title="Synthetic OD Qtrly Death Rates",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))

p4 <- ggplot(h.m, aes(x=yearqtr, y=edopioid_cr_ann, group = 1)) +
  geom_line(color="black",size=0.75)+
  geom_point(color="black") +
  labs(title="Opioid ED Visit 12-month Rates", x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001), plot.title = element_text(size=10), axis.text=element_text(size=8))

m1 <- ggplot() + 
  geom_polygon(data = cm, 
               aes(x=long, y=lat, group = group, fill = anyopioid_aa), 
               color = "black", 
               size = 0.25) + 
  coord_map() + 
  scale_fill_distiller(name="Rate per 100k - ", palette = "YlOrRd", trans="reverse", breaks = pretty_breaks(n = 5)) +
  theme_nothing() +
  theme(plot.title = element_text(size=10),
        legend.title = element_text(size=7),
        legend.text = element_text(size = 7),
        legend.position="bottom",
        legend.direction = "horizontal") +
  labs(title=wrapper(paste0("All Opioid Overdoses: ",maxyr," Age-Adjusted Annual Death Rates by County"), width = 40))

e1 <- ggplot(data=e.m, aes(x= demo, y=anyopioid_aa, fill = demo)) +
  geom_bar(stat="identity")+
  scale_fill_brewer(palette="Dark2")+
  #ggtitle() +
  labs(title= wrapper(paste0(maxyr," All Opioid OD Age-Adjusted Death Rates by Race/Ethnicity"), width = 45), x=NULL, y = NULL) +
  theme_classic()+
  theme(legend.position="none",plot.title = element_text(size=10),axis.text=element_text(size=8))

left_col <- plot_grid(p1, p2, p3, p4, labels = NULL, ncol = 1, align = 'v')

right_col <- plot_grid(m1, e1, labels = NULL, ncol = 1, rel_heights = c(2, 1))

od_c <- paste0(abs(round(((h.m[11,5]-h.m[3,5])/h.m[3,5])*100,digits=0)),"%") # if not using max year update the row numbers, leave column [5] unchanged

od_i <- ifelse(((h.m[11,5]-h.m[3,5])/h.m[3,5]) < 0,paste0("decrease"),paste0("increase")) # if not using max year update the row numbers, leave column [5] unchanged

od_s <- paste0("This represents a ",od_c," ",od_i," from ",minyr,".")

today <- Sys.Date() # creates object for current date

```
###`r paste0('California Opioid Overdose Snapshot',": ",h.m[1,3]," to ",h.m[12,3])` 
**Report downloaded `r paste0(format(today, format="%m-%d-%Y"))`**

California experienced `r paste0(h.s[3,2])` deaths due to all opioid-related overdoses in `r paste0(maxyr)`, the most recent calendar year of data available. The annual crude mortality rate during that period was `r paste0(round(h.m[11,5],digits=1))` per 100k residents. `r ifelse(h.m[3,5]==0,paste0(""),od_s)` The following charts present 12-month moving averages and annualized quarterly rates for selected opioid indicators. The map displays the annual county level rates for all opioid-related overdoses. Synthetic overdose deaths may be largely represented by fentanyl.

```{r, echo=FALSE, warning = FALSE, , message=TRUE, fig.height= 7, fig.width= 7, dev='CairoPNG'}
op <- par(omi=c(0,0,0,0))
plot_grid(left_col, right_col, labels = NULL, ncol = 2, rel_widths= c(1, 1.5))
par(op)
```

#####

```{r, echo=FALSE, warning = FALSE, message=TRUE }
c.c <- subset(crs_ca,
              crs_ca$type == 'total' &
              crs_ca$demo == '0',
              c("year", "qtr", 'opioidrx', 'opioidrx_cr', "mme_cr", "ninety_cr", "bzovrlp_cr", "buprx_cr")
)
c.c$yearqtr <- paste(c.c$year,c.c$qtr,sep="-Q")

c.m <- as.data.frame(lapply(c.c[ ,c(3,4,5,6,7,8)],mav))
c.m[,1] <- c.m[,1]*4
names(c.m)[c(2:6)] <- c(paste0('opioidrx_cr',"_ann"),paste0('mme_cr',"_ann"),paste0('ninety_cr',"_ann"),paste0('bzovrlp_cr',"_ann"),paste0('buprx_cr',"_ann"))
c.m <- cbind(c.c[,c(1:2,9)],c.m)
c.m <- as.data.frame(lapply(c.m, tail, 12))

c.s <- aggregate(c.c[c('opioidrx')], by=c.c["year"],  FUN=sum, na.rm=TRUE )
c.s <- as.data.frame(lapply(c.s, tail, 4)) #c.s <- as.data.frame(lapply(c.s, tail, 3)) prev. change 09/25/18 change back to this when 2018 is full year? 
#c.c <- as.data.frame(lapply(c.c, tail, 5))

#Plots

rx1 <- ggplot(c.m, aes(x=yearqtr, y=opioidrx_cr_ann, group= 1)) +
    geom_line(color="blue",size=0.75)+
    geom_point(color="blue") +
    labs(title="Opioid Prescriptions, 12-month Rates", x=NULL, y = NULL) +
    theme_classic() +
    theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8)) 

rx2 <- ggplot(c.m, aes(x=yearqtr, y=mme_cr_ann, group= 1)) +
  geom_line(color="steelblue",size=0.75)+
  geom_point(color="steelblue") +
  labs(title="MMEs per Person, 12-month Rates",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))

rx3 <- ggplot(c.m, aes(x=yearqtr, y=ninety_cr_ann, group= 1)) +
  geom_line(color="navy",size=0.75)+
  geom_point(color="navy") +
  labs(title=">90 MMEs, 12-month Rates",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))

rx4 <- ggplot(c.m, aes(x=yearqtr, y=bzovrlp_cr_ann, group= 1)) +
  geom_line(color="royalblue",size=0.75)+
  geom_point(color="royalblue") +
  labs(title="Overlapping Opioid/Benzos, 12-month Rates", x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))
```
###Prescribing 

There were `r paste0(format(c.s[3,2],big.mark=','))` prescriptions for opioids in California in `r paste0(maxyr)`, excluding buprenorphine. The annual prescribing rate during that period was `r paste0(round(c.m[11,5],digits=1))` per 1,000 residents. This represents a `r abs(round(((c.m[11,5]-c.m[3,5])/c.m[3,5])*100,digits=0))`% `r ifelse(((c.m[11,5]-c.m[3,5])/c.m[3,5]) < 0, paste0("decrease"),paste0("increase"))` in prescribing from `r paste0(minyr)`. The following charts present the annualized quarterly prescribing rates, MMEs (morphine milligram equivalents) per person per year, high dosage rate (i.e. greater than 90 Daily MMEs in the quarter), and the opioid/benzodiazepine overlap rate during `r paste0(maxyr)`.

```{r, echo=FALSE, warning = FALSE, , message=TRUE, fig.height= 3.5, fig.width= 7, dev='CairoPNG'}
op <- par(omi=c(0,0,0,0))
plot_grid(rx1, rx2, rx3, rx4, labels = NULL, ncol = 2)
par(op)
```

###Treatment

Buprenorphine prescriptions in the state are used to gauge the expansion of medication-assisted treatment (MAT). The annual buprenorphine prescribing rate in `r paste0(maxyr)` was `r paste0(round(c.m[11,9],digits=1))` per 1,000 residents. This represents a `r abs(round(((c.m[11,9]-c.m[3,9])/c.m[3,9])*100,digits=0))`% `r ifelse(((c.m[11,9]-c.m[3,9])/c.m[3,9]) < 0, paste0("decrease"),paste0("increase"))` in buprenorphine prescribing from `r paste0(minyr)`. 

```{r, echo=FALSE, warning = FALSE, , message=TRUE, fig.height= 2, fig.width= 7, dev='CairoPNG'}
op <- par(omi=c(0,0,0,0))
ggplot(c.m, aes(x=yearqtr, y=buprx_cr_ann, group= 1)) +
  geom_line(color="navy",size=0.75)+
  geom_point(color="navy") +
  labs(title="Buprenorphine Prescriptions, 12-month Rates", x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))
par(op)
```