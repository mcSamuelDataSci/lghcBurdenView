---
output:
  word_document:
    reference_docx: cntyReport_styles.docx
always_allow_html: yes
params:
  c: NA
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r process, echo=FALSE, warning = FALSE, message=TRUE }
#Packages.
#application
require(rmarkdown)
require(knitr)
require(shiny)
require(Rcpp)  # use C++ in R
#data
require(dplyr)
require(Hmisc) #data analysis
require(zoo)   #data analysis
#plots
require(ggplot2)
require(RColorBrewer) #color themes
require(cowplot)      #ggplot addon allowing themes and additions to plots
#map
require(rgdal)    #reading vector-based spatial data
require(sp)       #creates different spatial object types. defualt colorbrewer compatibility.
require(maptools) #tools for handling spatial objects
require(scales)   #resizing and map aesthetics
require(mapproj)  #converts lat/long into projected coords
require(Cairo)    #high-quality vector and bitmap output

# Page 1, Text Input Variables
county <- "County Name"
today  <- Sys.Date()

# Page 1, Data for plots 1-4, Previous Year Data for Measure 2
Measure1      <- data.frame(disease=c("D1","D2","D3","D4"),
                            estimate=c(4.2,10,29.5,16))
Measure2      <- data.frame(disease=c("D1","D2","D3","D4"),
                            estimate=c(4.2,10,29.5,16))
Measure2PrevY  <- data.frame(disease=c("D1","D2","D3","D4"),
                            estimate=c(6,10,29.5,16))
Measure3      <- data.frame(disease=c("D1","D2","D3","D4"),
                            estimate=c(4.2,10,29.5,16))
Measure4      <- data.frame(disease=c("D1","D2","D3","D4"),
                            estimate=c(4.2,10,29.5,16))

# Page 1, Data for Map
P1.DataMap1 <- data.frame(disease=c("D1","D2","D3","D4"),
                    estimate=c(4.2,10,29.5,16))

# Page 1, Data for Bar Plot
P1.DataBar1 <- data.frame(disease=c("D1","D2","D3","D4"),
                    estimate=c(4.2,10,29.5,16))

# Page 1, Plot Creation
P1.Plot1 <- ggplot(Measure1, aes(x=disease, y=estimate, group=1)) +
  geom_line(color="blue",size=0.75)+
  geom_point(color="blue") +
  labs(title="P1.Plot1, Measure1 Title", x=NULL, y = NULL) +
  theme_classic() +
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8)) 

P1.Plot2 <- ggplot(Measure2, aes(x=disease, y=estimate, group=1)) +
  geom_line(color="steelblue",size=0.75)+
  geom_point(color="steelblue") +
  labs(title="P1.Plot2, Measure2 Title",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))

P1.Plot3 <- ggplot(Measure3, aes(x=disease, y=estimate,group=1)) +
  geom_line(color="royalblue",size=0.75)+
  geom_point(color="royalblue") +
  labs(title="P1.Plot3, Measure3 Title",x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))

P1.Plot4 <- ggplot(Measure4, aes(x=disease, y=estimate, group=1)) +
  geom_line(color="black",size=0.75)+
  geom_point(color="black") +
  labs(title="P1.Plot4, Measure4 Title", x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001), plot.title = element_text(size=10), axis.text=element_text(size=8))

P1.Map1 <- ggplot(Measure4, aes(x=disease, y=estimate, group=1)) +
  geom_line(color="black",size=0.75)+
  geom_point(color="black") +
  labs(title="P1.Placeholder for map", x=NULL, y = NULL) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=-45, hjust=0.001), plot.title = element_text(size=10), axis.text=element_text(size=8))
  # ggplot() + 
  # geom_polygon(data = zm, 
  #              aes(x=long, y=lat, group = group, fill = anyopioid_aa), 
  #              color = "black", 
  #              size = 0.25) + 
  # coord_map() + 
  # scale_fill_distiller(name="Rate per 100k - ", palette = "YlOrRd", trans="reverse", breaks = pretty_breaks(n = 5)) +
  # theme_nothing() +
  # theme(plot.title = element_text(size=10),
  #       legend.title = element_text(size=7),
  #       legend.text = element_text(size = 7),
  #       legend.position="bottom",
  #       legend.direction = "horizontal") +
  # labs(title=wrapper(("P1.map1 Title"), width = 40))

P1.Bar1 <- ggplot(P1.DataBar1, aes(x= disease, y=estimate)) +
  geom_bar(stat="identity")+
  scale_fill_brewer(palette="Dark2")+
  labs(title= "P1.bar1 Title", x=NULL, y = NULL) +
  theme_classic()+
  theme(legend.position="none",plot.title = element_text(size=10),axis.text=element_text(size=8))

# Page 1, Sub-Layout
left_col  <- plot_grid(P1.Plot1, P1.Plot2, P1.Plot3, P1.Plot4, labels = NULL, ncol = 1, align = 'v')
right_col <- plot_grid(P1.Map1, P1.Bar1, labels = NULL, ncol = 1, rel_heights = c(2, 1))

# Page 1, Calculated Text Variables
DataYearBegin <- "DataYearBegin"
DataYearEnd   <- "DataYearEnd"
P1.Text1 <- paste0(abs(Measure2$estimate[1]-Measure2PrevY$estimate[1]),"%")
P1.Text2 <- ifelse(Measure2$estimate[1]-Measure2PrevY$estimate[1] < 0,paste0("decrease"),paste0("increase"))
P1.Text3 <- paste0("This represents a ",P1.Text1," ",P1.Text2," from ",DataYearBegin,".")

```
###`r paste0(county,' Measures of Health Status Snapshot',": ",DataYearBegin," to ",DataYearEnd)`
**Report downloaded `r paste0(format(today, format="%m-%d-%Y"))`**

`r paste0(county)` experienced `r paste0(Measure1$estimate[1])` `r as.character(bquote(Measure1))` due to `r paste0(Measure1$disease[1])` in `r paste0(DataYearEnd)`, the most recent calendar year of data available. The annual `r paste0(Measure2$disease[2])` `r as.character(bquote(Measure2))` rate during that period was `r paste0(round(Measure2$estimate[1],digits=1))` per 100k residents. `r ifelse(Measure2$estimate[1]==0,paste0(""),P1.Text3)` The following charts present 12-month moving averages and annualized quarterly rates for selected indicators. The map displays the annual county disease values for different measures.

```{r echo=FALSE, fig.height=7, fig.width=7, warning=FALSE, , message=TRUE, dev='CairoPNG'}
# Page 1, Layout
op <- par(omi=c(0,0,0,0))
plot_grid(left_col, right_col, labels = NULL, ncol = 2, rel_widths= c(1, 1.5))
par(op)
```

#####

```{r, echo=FALSE, warning = FALSE, message=TRUE }
# Page 2, Data for Plots 1-5
# c.c <- subset(crs_cnty,
#               crs_cnty$county == params$c &
#               crs_cnty$type == 'total' &
#               crs_cnty$demo == '0',
#               c("year", "qtr", 'opioidrx', 'opioidrx_cr', "mme_cr", "ninety_cr", "bzovrlp_cr", "buprx_cr")
# )
# c.c$yearqtr <- paste(c.c$year,c.c$qtr,sep="-Q")
# 
# c.m <- as.data.frame(lapply(c.c[ ,c(3,4,5,6,7,8)],mav))
# c.m[,1] <- c.m[,1]*4
# names(c.m)[c(2:6)] <- c(paste0('opioidrx_cr',"_ann"),paste0('mme_cr',"_ann"),paste0('ninety_cr',"_ann"),paste0('bzovrlp_cr',"_ann"),paste0('buprx_cr',"_ann"))
# c.m <- cbind(c.c[,c(1:2,9)],c.m)
# c.m <- as.data.frame(lapply(c.m, tail, 12))
# 
# c.s <- aggregate(c.c[c('opioidrx')], by=c.c["year"],  FUN=sum, na.rm=TRUE )
# c.s <- as.data.frame(lapply(c.s, tail, 4))
# 
# # Page 2, Plots 1-4
# rx1 <- ggplot(c.m, aes(x=yearqtr, y=opioidrx_cr_ann, group= 1)) +
#     geom_line(color="blue",size=0.75)+
#     geom_point(color="blue") +
#     labs(title="Opioid Prescriptions, 12-month Rates", x=NULL, y = NULL) +
#     theme_classic() +
#     theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8)) 
# 
# rx2 <- ggplot(c.m, aes(x=yearqtr, y=mme_cr_ann, group= 1)) +
#   geom_line(color="steelblue",size=0.75)+
#   geom_point(color="steelblue") +
#   labs(title="MMEs per Person, 12-month Rates",x=NULL, y = NULL) +
#   theme_classic()+
#   theme(axis.text.x=element_blank(),plot.title = element_text(size=10),axis.text=element_text(size=8))
# 
# rx3 <- ggplot(c.m, aes(x=yearqtr, y=ninety_cr_ann, group= 1)) +
#   geom_line(color="navy",size=0.75)+
#   geom_point(color="navy") +
#   labs(title=">90 MMEs, 12-month Rates",x=NULL, y = NULL) +
#   theme_classic()+
#   theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))
# 
# rx4 <- ggplot(c.m, aes(x=yearqtr, y=bzovrlp_cr_ann, group= 1)) +
#   geom_line(color="royalblue",size=0.75)+
#   geom_point(color="royalblue") +
#   labs(title="Overlapping Opioid/Benzos, 12-month Rates", x=NULL, y = NULL) +
#   theme_classic()+
#   theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))
```
###Prescribing 

There were `r paste0(format(c.s[3,2],big.mark=','))` prescriptions for opioids in `r paste0(params$c)` in `r paste0(maxyr)`, excluding buprenorphine. The annual prescribing rate during that period was `r paste0(round(c.m[11,5],digits=1))` per 1,000 residents. This represents a `r abs(round(((c.m[11,5]-c.m[4,5])/c.m[4,5])*100,digits=0))`% `r ifelse(((c.m[11,5]-c.m[4,5])/c.m[4,5]) < 0, paste0("decrease"),paste0("increase"))` in prescribing from `r paste0(minyr)`. The following charts present the annualized quarterly prescribing rates, MMEs (morphine milligram equivalents) per person per year, high dosage rate (i.e. greater than 90 Daily MMEs in the quarter), and the opioid/benzodiazepine overlap rate during `r paste0(maxyr)`.

```{r, echo=FALSE, warning = FALSE, , message=TRUE, fig.height= 3.5, fig.width= 7, dev='CairoPNG'}
# op <- par(omi=c(0,0,0,0))
# plot_grid(rx1, rx2, rx3, rx4, labels = NULL, ncol = 2)
# par(op)
```

###Treatment

Buprenorphine prescriptions in the county are used to gauge the expansion of medication-assisted treatment (MAT). The annual buprenorphine prescribing rate in `r paste0(maxyr)` was `r paste0(round(c.m[11,9],digits=1))` per 1,000 residents. This represents a `r abs(round(((c.m[11,9]-c.m[4,9])/c.m[4,9])*100,digits=0))`% `r ifelse(((c.m[11,9]-c.m[4,9])/c.m[4,9]) < 0, paste0("decrease"),paste0("increase"))` in buprenorphine prescribing from `r paste0(minyr)`. 

```{r, echo=FALSE, warning = FALSE, , message=TRUE, fig.height= 2, fig.width= 7, dev='CairoPNG'}
# op <- par(omi=c(0,0,0,0))
# # Page 2, Plot 5
# ggplot(c.m, aes(x=yearqtr, y=buprx_cr_ann, group= 1)) +
#   geom_line(color="navy",size=0.75)+
#   geom_point(color="navy") +
#   labs(title="Buprenorphine Prescriptions, 12-month Rates", x=NULL, y = NULL) +
#   theme_classic()+
#   theme(axis.text.x=element_text(angle=-45, hjust=0.001),plot.title = element_text(size=10),axis.text=element_text(size=8))
# par(op)
```